{% extends "activities_base.html" %}{% load bootstrap3 %}{% load staticfiles %}
{% block title %}{% if edit %} تعديل {{ form.name.value }} {% else %} نشاط جديد {% endif %}{% endblock %}

{% block content %}
<h2>{% if edit %} تعديل {{ form.name.value }} {% else %} نشاط جديد {% endif %}</h2>

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

<form action="{% if edit %}{% url 'activities:edit' activity_id %}{% else %}{% url 'activities:create' %}{% endif %}" method="post" class="form">
{% csrf_token %}

	{% comment %}------start_experimental------{% endcomment %}
	
	{% comment %}
	
	{% regroup form.fields by group as field_groups %}
	{% for group in field_groups %}
	<div class="group_{{ group.grouper }}">
	  {% for field in group.list %}
	    {% bootstrap_field field %}
	  {% endfor %}
	</div>
	{% endfor %}
	
	{% endcomment %}
	
	{% comment %}------end_experimental------{% endcomment %}
	
	{% bootstrap_form form %}
	
	<div id="episode_panel" class="panel panel-primary" data-collapsed="0">
			
			<!-- panel head -->
			<div class="panel-heading">
				<div class="panel-title">المواعيد</div>
				
				<div class="panel-options">
					<a href="#" data-rel="collapse"><i class="entypo-down-open"></i></a>
				</div>
			</div>
			
			<!-- panel body -->
		</div>
	
    {% buttons %}
    	<button type="submit" class="btn btn-primary btn-block">
    		{% bootstrap_icon "ok-sign" %} أرسل
    	</button>
    {% endbuttons %}
    
</form>

<script>
$(document).ready(function () {

// Hide the list of colleges if the participation checkbox is not
// chosen.
{% if not activity.collect_participants %}
$("#id_participant_colleges").siblings().hide();
$("#id_participant_colleges").hide();
{% endif %}{% comment %}
// FIXME: the collect_participants checkbox is not 'readonly', it can be modified.
{% endcomment %}
// Check if it's readonly, if not, hide list when unchecked.
$('#id_collect_participants').click(function() {
    if( $(this).is(':checked') && !($(this).is('[readonly]'))) {
        $("#id_participant_colleges").siblings().show("slow");
        $("#id_participant_colleges").show("slow");
    } else if  (!($(this).is(':checked')) && !($(this).is('[readonly]'))) {
        $("#id_participant_colleges").siblings().hide("slow");
        $("#id_participant_colleges").hide("slow");
    }
});

// Move the episode panel to the 6th position in the form
// (after the description field)
$('#episode_panel').insertAfter('form .form-group:nth-child(6)');
	
// Wrap all the fields related to episodes in a single div.
// This makes it much easier for styling.

// How many episodes are there?
var episode_count = $('input[name="episode_count"]').val();

// Based on this, mark all the episode fields with class 'episode_field'
for (i=0; i<episode_count; i++) {
	$('input[name="episode_pk' + i + '"]')
		.addClass('episode_field').addClass('episode_' + i);
	$('input[name="start_date' + i + '"]').parent()
		.addClass('episode_field').addClass('episode_' + i).addClass('date_field');
	$('input[name="end_date' + i + '"]').parent()
		.addClass('episode_field').addClass('episode_' + i).addClass('date_field');
	$('input[name="start_time' + i + '"]').parent()
		.addClass('episode_field').addClass('episode_' + i).addClass('time_field');
	$('input[name="end_time' + i + '"]').parent()
		.addClass('episode_field').addClass('episode_' + i).addClass('time_field');
	$('input[name="location' + i + '"]').parent()
		.addClass('episode_field').addClass('episode_' + i).addClass('loc_field');;
	
	// Wrap each episode in a div
	$('.episode_' + i).wrapAll("<div id='episode_" + i + "_container' class='episode_container' />");
}

// Now wrap all the episode_fields in a single div
$('.episode_container').wrapAll("<div id='episodes' class='panel-body' />");

// The counter is also logically relevant so add it also
// 'prepend' adds it to the beginning rather than the end
$('#episodes').prepend( $('input[name="episode_count"]') );

// -----------------

// Now give some style to the place
$('#episodes').appendTo('#episode_panel');

// Configure date pickers
// add attributes and init datepickers
$('.date_field input').attr('data-start-view', '1').datepicker({isRTL: true});

// Configure time pickers
$('.time_field input').timepicker({showMeridian: false})
	.on('show.timepicker', function(e) {
    $('.bootstrap-timepicker-widget').attr('dir', 'ltr'); // It appears reversed in rtl
  });

for (i=0; i<episode_count; i++) {
	
	// Wrap all fields together, as to separate them from the label
	$('.episode_field.episode_' + i)
		.wrapAll("<div class='col-md-11' />");
	
	// Add episode label
	$('#episode_' + i + '_container')
		.prepend("<div class='col-md-1'><h4>الموعد " + (i+1) + "</h4></div>");
	
	// Arrange episode fields into columns
	$('.episode_field.episode_' + i + '.date_field')
		.wrapAll("<div id='episode_" + i + "_dates' class='col-md-5' />");
	$('.episode_field.episode_' + i + '.time_field')
		.wrapAll("<div id='episode_" + i + "_times' class='col-md-4' />");
	$('.episode_field.episode_' + i + '.loc_field')
		.wrapAll("<div id='episode_" + i + "_loc' class='col-md-3' />");
		
	$('.episode_field.episode_' + i + '.date_field')
		.addClass('col-md-6');	
	$('.episode_field.episode_' + i + '.time_field')
		.addClass('col-md-6');
	$('.episode_field.episode_' + i + '.loc_field')
		.addClass('col-md-12');
	
} // end loop

// Append the 'add episode' button
	$('#episodes')
	.append('<button {% if edit and not activity.is_editable %}disabled=disabled {% endif %}id="btn_add_episode" type="button" class="btn btn-default btn-icon btn-xs">أضف موعدًا<i class="entypo-plus"></i></button>');
	// Upon clicking this button, a new episode will be added to the form, with all
	// the associeated fields
	$('#btn_add_episode').click(function () {		
		// Add a new episode and move this (button) to buttom
		var episode = '<div id="episode_{i}_container" class="episode_container"><div class="col-md-1"><h4>الموعد {i+1}</h4></div><div class="col-md-11"><div id="episode_{i}_dates" class="col-md-5"><div class="form-group episode_field episode_{i} date_field col-md-6"><label>تاريخ البداية</label><input class="form-control" id="id_start_date{i}" name="start_date{i}" placeholder="تاريخ البداية" required="required" type="text" data-start-view="1"></div><div class="form-group episode_field episode_{i} date_field col-md-6"><label>تاريخ النهاية</label><input class="form-control" id="id_end_date{i}" name="end_date{i}" placeholder="تاريخ النهاية" required="required" type="text" data-start-view="1"></div></div><div id="episode_{i}_times" class="col-md-4"><div class="form-group episode_field episode_{i} time_field col-md-6"><label>وقت البداية</label><input class="form-control" id="id_start_time{i}" name="start_time{i}" placeholder="وقت البداية" required="required" type="text"></div><div class="form-group episode_field episode_{i} time_field col-md-6"><label>وقت النهاية</label><input class="form-control" id="id_end_time{i}" name="end_time{i}" placeholder="وقت النهاية" required="required" type="text"></div></div><div id="episode_{i}_loc" class="col-md-3"><div class="form-group episode_field episode_{i} loc_field col-md-12"><label>المكان</label><input class="form-control" id="id_location{i}" maxlength="128" name="location{i}" placeholder="المكان" required="required" type="text"></div></div></div></div>'.replace(/{i}/g, episode_count).replace('{i+1}', parseInt(episode_count)+1);
		$(episode).insertBefore('#btn_add_episode');
		// Initialize date and time pickers
		
		// Configure date pickers
		// add attributes and init datepickers
		$('#episode_' + episode_count + '_dates .date_field input').attr('data-start-view', '1').datepicker({isRTL: true});
		
		console.log($('#episode_' + episode_count + '_dates .date_field input'));
		
		// Configure time pickers
		$('#episode_' + episode_count + '_times .time_field input').timepicker({showMeridian: false})
			.on('show.timepicker', function(e) {
		    $('.bootstrap-timepicker-widget').attr('dir', 'ltr'); // It appears reversed in rtl
		  });
		
		// Update episode_count
		episode_count++;
		$('input[name="episode_count"]').val(episode_count);
	});
});
</script>

{% endblock %}

{% block customscript %}
<!-- <script src="{% static 'neon/assets/js/bootstrap-datepicker.js' %}"></script> -->
<script src="{% static 'neon/assets/js/bootstrap-timepicker.min.js' %}"></script>
{% endblock %}

